name: ğŸ¤– Actualizar Resultados Diarios

on:
  # Se ejecuta todos los dÃ­as a las 8:00 PM (hora Venezuela)
  schedule:
    - cron: '0 0 * * *'  # 8pm en Venezuela son 0 UTC
  # TambiÃ©n permite ejecuciÃ³n manual desde la interfaz de GitHub
  workflow_dispatch:
    inputs:
      loteria:
        description: 'LoterÃ­a a actualizar (todas si se deja vacÃ­o)'
        required: false
        default: 'todas'
        type: choice
        options:
          - todas
          - lotto
          - granja
          - guacharo

# Permisos necesarios para escribir en el repositorio
permissions:
  contents: write
  actions: read

jobs:
  actualizar_resultados:
    runs-on: ubuntu-latest
    name: Actualizar JSON de resultados
    
    steps:
      - name: ğŸ“¥ Clonar repositorio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Obtener todo el historial para comparar cambios
      
      - name: ğŸ”§ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ğŸ“¦ Instalar dependencias (si las hay)
        run: |
          if [ -f package.json ]; then
            npm ci
          fi
        continue-on-error: true
      
      - name: ğŸ Configurar Python (opcional, por si prefieres Python)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ğŸ” Obtener resultados del dÃ­a
        id: obtener_datos
        run: |
          echo "ğŸ” Buscando resultados para $(date +%Y-%m-%d)"
          
          # Crear directorio temporal
          mkdir -p temp_resultados
          
          # AquÃ­ puedes elegir: JavaScript o Python
          # Yo recomiendo JavaScript por simplicidad
          
          # OpciÃ³n 1: JavaScript (recomendada)
          cat > temp_resultados/obtener_datos.js << 'EOF'
          const fs = require('fs');
          
          // SimulaciÃ³n de obtenciÃ³n de datos
          // EN EL FUTURO: AquÃ­ harÃ­as fetch a una API real
          function obtenerResultadosReales() {
            // Esto es un EJEMPLO - reemplÃ¡zalo con tu lÃ³gica real
            return {
              lotto: [35, 21, 16, 30, 0, 5, 28, 2, 29, 7, 36, 32],
              granja: [30, 29, 23, 38, 37, 8, 12, 36, 10, 22],
              guacharo: ["00", 36, 72, 22, 39, 71, 54, 27, 44, 0, 30, 59]
            };
          }
          
          const resultados = obtenerResultadosReales();
          fs.writeFileSync('temp_resultados/nuevos.json', JSON.stringify(resultados, null, 2));
          console.log('âœ… Datos obtenidos y guardados');
          EOF
          
          # Ejecutar el script JavaScript
          node temp_resultados/obtener_datos.js
          
          # Mostrar los datos obtenidos
          echo "ğŸ“Š Datos obtenidos:"
          cat temp_resultados/nuevos.json
      
      - name: ğŸ”„ Actualizar archivos JSON
        id: actualizar
        run: |
          echo "ğŸ”„ Actualizando archivos JSON..."
          
          # Crear script de actualizaciÃ³n
          cat > temp_resultados/actualizar.js << 'EOF'
          const fs = require('fs');
          const path = require('path');
          
          // FunciÃ³n para rotar resultados (mantener 3 dÃ­as)
          function rotarResultados(jsonActual, nuevosNumeros) {
            if (!jsonActual || !jsonActual.resultados || jsonActual.resultados.length !== 3) {
              return {
                resultados: [nuevosNumeros, nuevosNumeros, nuevosNumeros], // fallback
                fecha_actualizacion: new Date().toISOString()
              };
            }
            
            // Mantener: [dÃ­a mÃ¡s viejo, dÃ­a intermedio, dÃ­a nuevo]
            // Pero en realidad queremos: [dÃ­a intermedio, dÃ­a reciente, dÃ­a nuevo]
            const [diaViejo, diaMedio, diaReciente] = jsonActual.resultados;
            
            return {
              resultados: [diaMedio, diaReciente, nuevosNumeros],
              fecha_actualizacion: new Date().toISOString()
            };
          }
          
          // Cargar datos nuevos
          const nuevos = JSON.parse(fs.readFileSync('temp_resultados/nuevos.json'));
          
          // Procesar cada loterÃ­a
          const loterias = ['lotto', 'granja', 'guacharo'];
          let cambios = false;
          
          loterias.forEach(loteria => {
            const ruta = `data/${loteria}.json`;
            
            if (!fs.existsSync(ruta)) {
              console.log(`âš ï¸ ${ruta} no existe, creando...`);
              // Crear archivo por defecto si no existe
              const defaultData = {
                resultados: [
                  Array(loteria === 'granja' ? 10 : 12).fill(0),
                  Array(loteria === 'granja' ? 10 : 12).fill(0),
                  nuevos[loteria] || Array(loteria === 'granja' ? 10 : 12).fill(0)
                ],
                fecha_actualizacion: new Date().toISOString()
              };
              fs.writeFileSync(ruta, JSON.stringify(defaultData, null, 2));
              cambios = true;
              console.log(`âœ… ${ruta} creado`);
              return;
            }
            
            try {
              const actual = JSON.parse(fs.readFileSync(ruta, 'utf8'));
              
              if (nuevos[loteria]) {
                const actualizado = rotarResultados(actual, nuevos[loteria]);
                
                // Solo escribir si hay cambios
                if (JSON.stringify(actual) !== JSON.stringify(actualizado)) {
                  fs.writeFileSync(ruta, JSON.stringify(actualizado, null, 2));
                  cambios = true;
                  console.log(`âœ… ${ruta} actualizado`);
                } else {
                  console.log(`â¸ï¸ ${ruta} sin cambios`);
                }
              }
            } catch (error) {
              console.error(`âŒ Error procesando ${ruta}:`, error.message);
            }
          });
          
          // Guardar flag de cambios
          fs.writeFileSync('temp_resultados/hubo_cambios', cambios ? 'true' : 'false');
          EOF
          
          # Ejecutar script de actualizaciÃ³n
          node temp_resultados/actualizar.js
          
          # Verificar si hubo cambios
          if [ -f temp_resultados/hubo_cambios ]; then
            HUBO_CAMBIOS=$(cat temp_resultados/hubo_cambios)
            echo "HUBO_CAMBIOS=$HUBO_CAMBIOS" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ“¤ Commit y push automÃ¡tico
        if: steps.actualizar.outputs.HUBO_CAMBIOS == 'true'
        run: |
          git config --global user.name "Dr. Animalitos Bot"
          git config --global user.email "bot@tuanimalito.github.io"
          
          git add data/*.json
          
          # Fecha actual para el mensaje
          FECHA=$(date +"%d/%m/%Y")
          
          git commit -m "ğŸ¤– ActualizaciÃ³n automÃ¡tica de resultados - ${FECHA}"
          git push
          
          echo "âœ… Cambios subidos a GitHub"
      
      - name: â„¹ï¸ No hay cambios
        if: steps.actualizar.outputs.HUBO_CAMBIOS != 'true'
        run: |
          echo "â¸ï¸ No se detectaron cambios en los resultados. No se realizÃ³ commit."
      
      - name: ğŸ“Š Resumen final
        run: |
          echo "ğŸ‰ Proceso completado exitosamente"
          echo "ğŸ“… Fecha: $(date)"
          echo "ğŸ“ Repositorio: ${{ github.repository }}"
