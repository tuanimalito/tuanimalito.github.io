name: Actualizar Resultados Lotto Activo (Oficial)

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  actualizar:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Clonar repositorio
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: Obtener HTML v√≠a ScrapingBee (Fuente Oficial)
        env:
          SCRAPINGBEE_API_KEY: ${{ secrets.SCRAPINGBEE_API_KEY }}
        run: |
          echo "üîç Obteniendo resultados de la fuente oficial v√≠a ScrapingBee..."
          FECHA_ACTUAL=$(date +'%Y-%m-%d')
          echo "üìÖ Fecha solicitada: $FECHA_ACTUAL"
          
          URL="https://www.lottoactivo.com/resultados/animalitos/${FECHA_ACTUAL}/"
          echo "üåê URL: $URL"
          
          # Llamada a ScrapingBee con par√°metros optimizados
          curl -s -L "https://app.scrapingbee.com/api/v1/?api_key=${SCRAPINGBEE_API_KEY}&url=${URL}&render_js=false&premium_proxy=true&country_code=ve" > pagina_completa.html
          
          echo "‚úÖ HTML recibido. Tama√±o: $(wc -l < pagina_completa.html) l√≠neas"
          echo "üìÑ Primeras 5 l√≠neas del HTML:"
          head -5 pagina_completa.html
          
      - name: Mostrar HTML para depuraci√≥n
        run: |
          echo "üìÑ PRIMERAS 50 L√çNEAS DEL HTML:"
          echo "========================================"
          head -50 pagina_completa.html
          echo "========================================"
          
      - name: Configurar Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Extraer n√∫meros de Lotto Activo
        run: |
          cat > extraer.js << 'EOF'
          const fs = require('fs');
          
          console.log("üîç Analizando HTML de la fuente oficial...");
          const html = fs.readFileSync('pagina_completa.html', 'utf8');
          
          // Buscar espec√≠ficamente los resultados de Lotto Activo
          // Patr√≥n basado en la estructura HTML que proporcionaste
          const regex = /<div[^>]*class="[^"]*col[^"]*"[^>]*>[\s\S]*?<span[^>]*class="[^"]*badge[^"]*"[^>]*>(\d{1,2})<\/span>\s*([A-Za-z√Å-√∫]+)<\/h6>[\s\S]*?Lotto Activo\s*(\d{2}:\d{2}\s*(?:AM|PM))<\/p>/gi;
          
          const numeros = [];
          let match;
          let contador = 0;
          
          console.log("\nüìå Resultados de Lotto Activo encontrados:");
          console.log("========================================");
          
          while ((match = regex.exec(html)) !== null) {
            contador++;
            const numero = parseInt(match[1]);
            const animal = match[2];
            const hora = match[3];
            
            // Validar rango 0-36
            if (numero >= 0 && numero <= 36) {
              numeros.push(numero);
              const numeroDisplay = numero === 0 ? '00' : numero.toString().padStart(2, '0');
              console.log(`  ${contador}. ${numeroDisplay} - ${animal} (${hora})`);
            }
          }
          
          console.log("========================================");
          console.log(`\nüìä Total sorteos encontrados: ${numeros.length}`);
          
          // Si no encuentra con el primer m√©todo, intentar con b√∫squeda m√°s simple
          if (numeros.length === 0) {
            console.log("\n‚ö†Ô∏è Usando m√©todo de respaldo (b√∫squeda simple)...");
            
            // Buscar cualquier badge con n√∫mero seguido de nombre
            const regexSimple = /<span[^>]*class="[^"]*badge[^"]*"[^>]*>(\d{1,2})<\/span>\s*([A-Za-z√Å-√∫]+)<\/h6>/g;
            
            while ((match = regexSimple.exec(html)) !== null) {
              const numero = parseInt(match[1]);
              if (numero >= 0 && numero <= 36) {
                numeros.push(numero);
                console.log(`  ‚úì ${numero} (m√©todo simple)`);
              }
            }
          }
          
          // Eliminar duplicados y ordenar
          const numerosUnicos = [...new Set(numeros)].sort((a, b) => a - b);
          
          console.log(`\nüìã N√∫meros √∫nicos encontrados: ${numerosUnicos.length}`);
          console.log(`üìã N√∫meros: ${numerosUnicos.join(', ')}`);
          
          // Guardar resultados
          const datos = {
            resultados: numerosUnicos,
            fecha_actualizacion: new Date().toISOString(),
            total_resultados: numerosUnicos.length,
            fuente: "lottoactivo.com (oficial v√≠a ScrapingBee)"
          };
          
          fs.writeFileSync('resultados.json', JSON.stringify(datos, null, 2));
          console.log('\n‚úÖ resultados.json guardado correctamente');
          EOF
          
      - name: Ejecutar extracci√≥n
        run: node extraer.js
        
      - name: Verificar resultado final
        run: |
          echo "üìÅ Contenido de resultados.json:"
          cat resultados.json
          
      - name: Guardar cambios en el repositorio
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git reset --soft origin/main
          git add resultados.json
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è Sin cambios en resultados.json"
          else
            git commit -m "üîÑ Actualizaci√≥n oficial Lotto Activo [$(date +'%Y-%m-%d %H:%M')]"
            git push origin HEAD:main
            echo "‚úÖ Cambios subidos exitosamente"
          fi
