name: Actualizar resultados rotando los 3 dÃ­as

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  rotar_resultados:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Clonar repositorio
        uses: actions/checkout@v3

      - name: Obtener resultados de hoy desde El Brujo
        run: |
          curl -s -L "https://elbrujodelosanimalitos.com/resultados-animalitos/" > hoy.html

      - name: Extraer nÃºmeros de Lotto Activo (hoy) - VERSIÃ“N MEJORADA
        run: |
          # Extraer nÃºmeros de forma mÃ¡s robusta
          numeros_hoy=$(grep -A20 '## Lotto Activo' hoy.html | grep -E '[0-9]+ -' | sed -E 's/.*([0-9]+) -.*/\1/' | head -12 | tr '\n' ',' | sed 's/,$//')
          echo "NUMEROS_HOY=$numeros_hoy" >> $GITHUB_ENV
          echo "ðŸ“Š NÃºmeros de hoy extraÃ­dos: $numeros_hoy"

      - name: Leer resultados.json anterior y rotar - VERSIÃ“N CORREGIDA
        run: |
          # Si existe resultados.json, lo leemos
          if [ -f resultados.json ]; then
            OLD_JSON=$(cat resultados.json)
            
            # Extraer cada array por separado
            DIA1_ARRAY=$(echo "$OLD_JSON" | grep -oP '(?<="resultados": \[)[^\]]+' | head -1 | tr -d ' ' | sed 's/,/ /g')
            DIA2_ARRAY=$(echo "$OLD_JSON" | grep -oP '(?<="resultados": \[)[^\]]+' | tail -2 | head -1 | tr -d ' ' | sed 's/,/ /g')
            DIA3_ARRAY=$(echo "$OLD_JSON" | grep -oP '(?<="resultados": \[)[^\]]+' | tail -1 | tr -d ' ' | sed 's/,/ /g')
            
            # Rotar: el dÃ­a -3 se elimina, los demÃ¡s se desplazan
            NUEVO_DIA1=$(echo $DIA2_ARRAY | tr ' ' ',')
            NUEVO_DIA2=$(echo $DIA3_ARRAY | tr ' ' ',')
            NUEVO_DIA3=${{ env.NUMEROS_HOY }}
          else
            # Si no existe, usamos los datos que ya tenÃ­as como base
            NUEVO_DIA1="35,21,16,30,0,5,28,2,29,7,36,32"
            NUEVO_DIA2="28,8,30,27,1,32,7,0,17,24,2,19"
            NUEVO_DIA3="${{ env.NUMEROS_HOY }}"
          fi

          echo "âœ… Nuevo dÃ­a -3: $NUEVO_DIA1"
          echo "âœ… Nuevo dÃ­a -2: $NUEVO_DIA2"
          echo "âœ… Nuevo dÃ­a -1: $NUEVO_DIA3"

          # Guardar en nuevo JSON
          cat > resultados.json << EOF
          {
            "resultados": [$NUEVO_DIA1, $NUEVO_DIA2, $NUEVO_DIA3],
            "fecha_actualizacion": "$(date -Iseconds)",
            "total_resultados": 36,
            "dias": {
              "dia_menos_3": "$(date -d '3 days ago' +'%Y-%m-%d')",
              "dia_menos_2": "$(date -d '2 days ago' +'%Y-%m-%d')",
              "dia_menos_1": "$(date -d '1 day ago' +'%Y-%m-%d')"
            }
          }
          EOF

      - name: Guardar cambios
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add resultados.json
          git diff --quiet && git diff --staged --quiet || git commit -m "ðŸ”„ Resultados rotados automÃ¡ticamente"
          git push
