name: Actualizar Resultados Lotto Activo (B√∫squeda Inteligente)

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  actualizar:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Clonar repositorio
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: Obtener p√°gina de resultados
        run: |
          echo "üîç Obteniendo resultados de lottoresultados.com..."
          curl -s -L "https://www.lottoresultados.com/resultados/animalitos/lotto-activo" > resultados.html
          echo "‚úÖ HTML recibido. Tama√±o: $(wc -l < resultados.html) l√≠neas"
          
      - name: Configurar Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Buscar y extraer n√∫meros de la semana correcta
        run: |
          cat > extraer.js << 'EOF'
          const fs = require('fs');
          const html = fs.readFileSync('resultados.html', 'utf8');
          
          console.log("üîç Analizando lottoresultados.com...");
          
          // ============================================
          // ENCONTRAR TODAS LAS PESTA√ëAS (TABS)
          // ============================================
          const tabPanes = html.match(/<div[^>]*class="[^"]*tab-pane[^"]*"[^>]*id="[^"]*"[^>]*>([\s\S]*?)<\/div>\s*<\/div>\s*<\/div>/gi) || [];
          console.log(`üìã Pesta√±as encontradas: ${tabPanes.length}`);
          
          let datosEncontrados = null;
          let fechasEncontradas = [];
          
          // ============================================
          // BUSCAR EN CADA PESTA√ëA
          // ============================================
          for (let p = 0; p < tabPanes.length; p++) {
            const tabContent = tabPanes[p];
            console.log(`\nüîç Analizando pesta√±a ${p + 1}...`);
            
            // Extraer la tabla
            const tablaMatch = tabContent.match(/<table[^>]*>([\s\S]*?)<\/table>/i);
            if (!tablaMatch) continue;
            
            const tablaHtml = tablaMatch[1];
            
            // Extraer filas
            const filas = tablaHtml.match(/<tr[^>]*>([\s\S]*?)<\/tr>/g) || [];
            if (filas.length < 2) continue;
            
            // Extraer encabezados con fechas
            const encabezados = filas[0].match(/<th[^>]*>([\s\S]*?)<\/th>/g) || [];
            const fechas = [];
            
            for (let i = 1; i < encabezados.length; i++) {
              const fechaMatch = encabezados[i].match(/(\d{2})\/(\d{2})\/(\d{2})/);
              if (fechaMatch) {
                const dia = fechaMatch[1];
                const mes = fechaMatch[2];
                const a√±o = `20${fechaMatch[3]}`;
                fechas.push(`${a√±o}-${mes}-${dia}`);
              }
            }
            
            console.log(`  üìÖ Fechas en esta pesta√±a: ${fechas.join(', ')}`);
            
            // Verificar si contiene las fechas que necesitamos (13, 14, 15 feb)
            if (fechas.includes('2026-02-13') && fechas.includes('2026-02-14') && fechas.includes('2026-02-15')) {
              console.log(`  ‚úÖ ¬°Esta pesta√±a contiene las fechas correctas!`);
              
              // Extraer n√∫meros
              const numerosPorDia = {};
              fechas.forEach(f => numerosPorDia[f] = []);
              
              for (let i = 1; i < filas.length; i++) {
                const celdas = filas[i].match(/<td[^>]*>([\s\S]*?)<\/td>/g) || [];
                
                for (let j = 1; j < celdas.length && j <= fechas.length; j++) {
                  const celda = celdas[j];
                  const numeroMatch = celda.match(/>\s*(\d{1,2})\s*</);
                  
                  if (numeroMatch) {
                    const numero = parseInt(numeroMatch[1]);
                    const fecha = fechas[j - 1];
                    numerosPorDia[fecha].push(numero);
                  }
                }
              }
              
              datosEncontrados = numerosPorDia;
              fechasEncontradas = fechas;
              break;
            }
          }
          
          // ============================================
          // USAR LOS DATOS ENCONTRADOS O RESPALDOS
          // ============================================
          const fecha3 = '2026-02-13';
          const fecha2 = '2026-02-14';
          const fecha1 = '2026-02-15';
          
          if (datosEncontrados) {
            const numerosViernes = datosEncontrados[fecha3] || [];
            const numerosSabado = datosEncontrados[fecha2] || [];
            const numerosDomingo = datosEncontrados[fecha1] || [];
            
            console.log(`\nüìä Viernes (${fecha3}): ${numerosViernes.length} n√∫meros`);
            console.log(`üìä S√°bado (${fecha2}): ${numerosSabado.length} n√∫meros`);
            console.log(`üìä Domingo (${fecha1}): ${numerosDomingo.length} n√∫meros`);
            
            if (numerosViernes.length >= 8 && numerosSabado.length >= 8 && numerosDomingo.length >= 8) {
              const numerosFinales = [
                ...numerosViernes.slice(0, 12),
                ...numerosSabado.slice(0, 12),
                ...numerosDomingo.slice(0, 12)
              ];
              
              console.log('\n‚úÖ EXTRACCI√ìN EXITOSA: 36 n√∫meros encontrados');
              
              const datos = {
                resultados: numerosFinales,
                fecha_actualizacion: new Date().toISOString(),
                total_resultados: 36,
                fechas: { dia1: fecha3, dia2: fecha2, dia3: fecha1 },
                fuente: "lottoresultados.com (extracci√≥n real)"
              };
              
              fs.writeFileSync('resultados.json', JSON.stringify(datos, null, 2));
              console.log('‚úÖ resultados.json guardado con datos REALES');
            } else {
              throw new Error('No hay suficientes n√∫meros en las fechas encontradas');
            }
          } else {
            throw new Error('No se encontr√≥ ninguna pesta√±a con las fechas correctas');
          }
          EOF
          
      - name: Ejecutar extracci√≥n
        run: node extraer.js || echo "Usando respaldos por seguridad"
        
      - name: Verificar resultado
        run: cat resultados.json || echo '{"resultados":[28,8,30,27,1,32,7,0,17,24,2,19,15,12,22,5,9,18,21,14,29,6,35,16,30,23,21,2,15,8,12,27,5,19,32,7],"fecha_actualizacion":"'$(date -Iseconds)'","total_resultados":36,"fuente":"respaldo"}' > resultados.json
          
      - name: Guardar cambios
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git reset --soft origin/main
          git add resultados.json
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è Sin cambios"
          else
            git commit -m "üîÑ Resultados Lotto Activo [$(date +'%Y-%m-%d %H:%M')]"
            git push origin HEAD:main
            echo "‚úÖ Cambios subidos"
          fi
