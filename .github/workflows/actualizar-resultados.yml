name: Actualizar Resultados Lotto Activo

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  actualizar:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Clonar repositorio
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: Obtener y GUARDAR el HTML completo
        run: |
          echo "üîç Obteniendo HTML de loteriadehoy.com..."
          curl -s -L -v "https://loteriadehoy.com/animalito/lottoactivo/resultados/" > pagina_completa.html
          echo "‚úÖ HTML guardado. Tama√±o: $(wc -l < pagina_completa.html) l√≠neas"
          
      - name: MOSTRAR el HTML (para depuraci√≥n)
        run: |
          echo "üìÑ PRIMERAS 50 L√çNEAS DEL HTML:"
          echo "========================================"
          head -50 pagina_completa.html
          echo "========================================"
          echo ""
          echo "üîç BUSCANDO PATRONES DE N√öMEROS:"
          echo "========================================"
          grep -E '<h4>[0-9]+' pagina_completa.html | head -10
          echo "========================================"
          
      - name: Configurar Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Extraer n√∫meros con EXPRESI√ìN CORRECTA
        run: |
          cat > extraer.js << 'EOF'
          const fs = require('fs');
          
          console.log("üîç Leyendo HTML guardado...");
          const html = fs.readFileSync('pagina_completa.html', 'utf8');
          
          console.log("üìä Buscando n√∫meros en el HTML...");
          
          // M√âTODO 1: Buscar patr√≥n exacto de loteriadehoy
          const regex = /<h4>(\d{1,2})\s+([A-Za-z√Å-√∫]+)<\/h4>/g;
          const numeros = [];
          let match;
          
          console.log("\nüìå N√∫meros encontrados en <h4>:");
          while ((match = regex.exec(html)) !== null) {
            const numero = parseInt(match[1]);
            const animal = match[2];
            console.log(`  ‚úì ${numero} - ${animal}`);
            numeros.push(numero);
          }
          
          console.log(`\nüìä Total encontrados: ${numeros.length}`);
          
          // Guardar resultados
          const datos = {
            resultados: numeros,
            fecha_actualizacion: new Date().toISOString(),
            total_resultados: numeros.length,
            html_preview: html.substring(0, 200) // Guardar preview para depuraci√≥n
          };
          
          fs.writeFileSync('resultados.json', JSON.stringify(datos, null, 2));
          console.log('‚úÖ resultados.json guardado');
          EOF
          
      - name: Ejecutar extracci√≥n
        run: node extraer.js
        
      - name: Verificar resultado
        run: cat resultados.json
        
      - name: Guardar HTML para inspecci√≥n (opcional)
        run: |
          git add pagina_completa.html || true
          
      - name: Guardar cambios
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git reset --soft origin/main
          git add resultados.json
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è Sin cambios en resultados.json"
          else
            git commit -m "üîÑ Actualizaci√≥n autom√°tica $(date +'%Y-%m-%d %H:%M')"
            git push origin HEAD:main
            echo "‚úÖ Cambios subidos"
          fi
