name: Actualizar Resultados Lotto Activo

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  actualizar:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Clonar repositorio
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: Obtener p√°gina de resultados
        run: |
          echo "üîç Obteniendo resultados de Lotto Activo..."
          curl -s -L "https://loteriadehoy.com/animalito/lottoactivo/resultados/" > resultados.html
          
      - name: Extraer n√∫meros con Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Crear script de extracci√≥n
        run: |
          cat > extraer.js << 'EOF'
          const fs = require('fs');
          const html = fs.readFileSync('resultados.html', 'utf8');
          
          console.log("üîç Analizando HTML...");
          
          // Buscar n√∫meros con animales
          const regex = /<h4[^>]*>(\d{1,2})\s+([A-Za-z√Å-√∫]+)<\/h4>/gi;
          const numeros = [];
          let match;
          
          while ((match = regex.exec(html)) !== null) {
            const numero = parseInt(match[1]);
            if (numero >= 0 && numero <= 36) {
              numeros.push(numero);
              console.log(`‚úì Encontrado: ${numero}`);
            }
          }
          
          console.log(`üìä Total n√∫meros encontrados: ${numeros.length}`);
          
          const datos = {
            resultados: numeros.slice(0, 36),
            fecha_actualizacion: new Date().toISOString(),
            total_resultados: numeros.length
          };
          
          fs.writeFileSync('resultados.json', JSON.stringify(datos, null, 2));
          console.log('‚úÖ Archivo resultados.json actualizado');
          EOF
          
      - name: Ejecutar script
        run: node extraer.js
        
      - name: Mostrar resultado
        run: cat resultados.json
        
      - name: Configurar Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
      - name: Guardar cambios (forzar actualizaci√≥n)
        run: |
          # Traer √∫ltimos cambios
          git fetch origin main
          git reset --soft origin/main
          
          # Agregar y commitear
          git add resultados.json
          git diff --quiet && git diff --staged --quiet || git commit -m "üîÑ Actualizaci√≥n autom√°tica [$(date +'%Y-%m-%d %H:%M')]"
          
          # Forzar push (sobrescribe cualquier conflicto)
          git push origin HEAD:main --force
