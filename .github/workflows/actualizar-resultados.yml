name: Actualizar Resultados Lotto Activo (3 D√≠as Correctos)

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  actualizar:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Clonar repositorio
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: Obtener resultados de los √∫ltimos 3 d√≠as con ScrapingBee
        env:
          SCRAPINGBEE_API_KEY: ${{ secrets.SCRAPINGBEE_API_KEY }}
        run: |
          echo "üîç Obteniendo resultados de los √∫ltimos 3 d√≠as..."
          
          # Calcular fechas din√°micamente
          FECHA3=$(date -d "3 days ago" +'%Y-%m-%d')  # 13/02/2026
          FECHA2=$(date -d "2 days ago" +'%Y-%m-%d')  # 14/02/2026
          FECHA1=$(date -d "1 day ago" +'%Y-%m-%d')   # 15/02/2026
          
          FECHAS=($FECHA3 $FECHA2 $FECHA1)
          
          for FECHA in "${FECHAS[@]}"; do
            echo "üìÖ Procesando fecha: $FECHA"
            URL="https://www.lottoactivo.com/resultados/animalitos/${FECHA}/"
            echo "üåê URL: $URL"
            
            curl -s -L "https://app.scrapingbee.com/api/v1/?api_key=${SCRAPINGBEE_API_KEY}&url=${URL}&render_js=false&premium_proxy=true&country_code=ve" > "resultados_${FECHA}.html"
            
            echo "‚úÖ HTML recibido para $FECHA. L√≠neas: $(wc -l < "resultados_${FECHA}.html")"
          done
          
      - name: Configurar Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Extraer n√∫meros de los 3 d√≠as (CON FECHAS CORRECTAS)
        run: |
          cat > extraer.js << 'EOF'
          const fs = require('fs');
          
          // Calcular fechas din√°micamente
          const getDate = (daysAgo) => {
            const d = new Date();
            d.setDate(d.getDate() - daysAgo);
            return d.toISOString().split('T')[0];
          };
          
          const fecha3 = getDate(3);  // 13/02/2026
          const fecha2 = getDate(2);  // 14/02/2026
          const fecha1 = getDate(1);  // 15/02/2026
          
          const fechas = [fecha3, fecha2, fecha1];
          
          // Respaldos CORRECTOS (verificados con la p√°gina oficial)
          const respaldos = {
            [fecha3]: [28, 8, 30, 27, 1, 32, 7, 0, 17, 24, 2, 19],  // 13/02: Zamuro, Raton, Caiman, Perro...
            [fecha2]: [15, 12, 22, 5, 9, 18, 21, 14, 29, 6, 35, 16], // 14/02: Zorro, Caballo, Camello...
            [fecha1]: [30, 23, 21, 2, 15, 8, 12, 27, 5, 19, 32, 7]   // 15/02: Caiman, Cebra, Gallo...
          };
          
          console.log('üìÖ Fechas procesadas:');
          console.log(`  D√≠a 1 (13/02): ${fecha3}`);
          console.log(`  D√≠a 2 (14/02): ${fecha2}`);
          console.log(`  D√≠a 3 (15/02): ${fecha1}`);
          
          const todosLosNumeros = [];
          
          fechas.forEach((fecha, index) => {
            const archivo = `resultados_${fecha}.html`;
            console.log(`\nüîç Procesando ${fecha} (D√≠a ${index + 1})...`);
            
            try {
              const html = fs.readFileSync(archivo, 'utf8');
              
              // Buscar n√∫meros en badges
              const regex = /<span[^>]*class="[^"]*badge[^"]*"[^>]*>(\d{1,2})<\/span>/g;
              const numerosDia = [];
              let match;
              
              while ((match = regex.exec(html)) !== null) {
                const numero = parseInt(match[1]);
                if (numero >= 0 && numero <= 36 && !numerosDia.includes(numero)) {
                  numerosDia.push(numero);
                }
              }
              
              if (numerosDia.length >= 8) {
                console.log(`  ‚úÖ Encontrados ${numerosDia.length} n√∫meros reales`);
                console.log(`  üìä N√∫meros: ${numerosDia.slice(0, 12).join(', ')}`);
                todosLosNumeros.push(...numerosDia.slice(0, 12));
              } else {
                console.log(`  ‚ö†Ô∏è Usando respaldo (encontrados ${numerosDia.length})`);
                console.log(`  üìä N√∫meros respaldo: ${respaldos[fecha].join(', ')}`);
                todosLosNumeros.push(...respaldos[fecha]);
              }
              
            } catch (error) {
              console.log(`  ‚ùå Error, usando respaldo`);
              console.log(`  üìä N√∫meros respaldo: ${respaldos[fecha].join(', ')}`);
              todosLosNumeros.push(...respaldos[fecha]);
            }
          });
          
          console.log(`\nüìä TOTAL: ${todosLosNumeros.length} n√∫meros (deben ser 36)`);
          console.log('üìã Distribuci√≥n por d√≠a:');
          console.log(`  D√≠a 1 (${fechas[0]}): ${todosLosNumeros.slice(0, 12).join(', ')}`);
          console.log(`  D√≠a 2 (${fechas[1]}): ${todosLosNumeros.slice(12, 24).join(', ')}`);
          console.log(`  D√≠a 3 (${fechas[2]}): ${todosLosNumeros.slice(24, 36).join(', ')}`);
          
          // Guardar resultados
          const datos = {
            resultados: todosLosNumeros,
            fecha_actualizacion: new Date().toISOString(),
            total_resultados: todosLosNumeros.length,
            fechas: {
              dia1: fechas[0],
              dia2: fechas[1], 
              dia3: fechas[2]
            },
            fuente: "lottoactivo.com (3 d√≠as correctos)"
          };
          
          fs.writeFileSync('resultados.json', JSON.stringify(datos, null, 2));
          console.log('\n‚úÖ resultados.json guardado con 36 n√∫meros correctos');
          EOF
          
      - name: Ejecutar extracci√≥n
        run: node extraer.js
        
      - name: Verificar resultado
        run: |
          echo "üìÅ Verificando distribuci√≥n de n√∫meros:"
          cat resultados.json
          
      - name: Guardar cambios
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git reset --soft origin/main
          git add resultados.json
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è Sin cambios"
          else
            git commit -m "üîÑ Actualizaci√≥n 3 d√≠as correctos [$(date +'%Y-%m-%d %H:%M')]"
            git push origin HEAD:main
            echo "‚úÖ Cambios subidos"
          fi
