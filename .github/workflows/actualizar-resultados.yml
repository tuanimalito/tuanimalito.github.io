name: Actualizar Resultados Lotto Activo

on:
  schedule:
    # Se ejecuta cada 6 horas
    - cron: '0 */6 * * *'
  workflow_dispatch:  # Permite ejecuci√≥n manual

jobs:
  actualizar:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Clonar repositorio
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: Obtener p√°gina de resultados
        run: |
          echo "üîç Obteniendo resultados de Lotto Activo desde loteriadehoy.com..."
          curl -s -L "https://loteriadehoy.com/animalito/lottoactivo/resultados/" > resultados.html
          echo "‚úÖ P√°gina descargada correctamente"
          
      - name: Configurar Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Extraer n√∫meros con script mejorado
        run: |
          cat > extraer.js << 'EOF'
          const fs = require('fs');
          const html = fs.readFileSync('resultados.html', 'utf8');
          
          console.log("üîç Analizando HTML de loteriadehoy.com...");
          console.log("üìÑ Tama√±o del HTML:", html.length, "caracteres");
          
          // M√âTODO 1: Buscar n√∫meros en etiquetas h4 (formato espec√≠fico de loteriadehoy)
          console.log("\nüìå M√©todo 1: Buscando en etiquetas <h4>...");
          const regexH4 = /<h4[^>]*>(\d{1,2})\s+([A-Za-z√Å-√∫]+)<\/h4>/gi;
          const numeros = [];
          let match;
          
          while ((match = regexH4.exec(html)) !== null) {
            const numero = parseInt(match[1]);
            const animal = match[2];
            if (numero >= 0 && numero <= 36) {
              numeros.push(numero);
              console.log(`  ‚úì Encontrado: ${numero} - ${animal}`);
            }
          }
          
          console.log(`  üìä Total encontrados con h4: ${numeros.length}`);
          
          // M√âTODO 2: Si no encuentra suficientes, buscar cualquier n√∫mero seguido de animal
          if (numeros.length < 8) {
            console.log("\nüìå M√©todo 2: Usando b√∫squeda gen√©rica...");
            const regexGeneral = /[^0-9](\d{1,2})[^0-9]*?([A-Za-z√Å-√∫]+)/g;
            let match2;
            const numerosGenericos = [];
            
            while ((match2 = regexGeneral.exec(html)) !== null) {
              const numero = parseInt(match2[1]);
              if (numero >= 0 && numero <= 36 && !numerosGenericos.includes(numero)) {
                numerosGenericos.push(numero);
                console.log(`  ‚úì Encontrado (gen√©rico): ${numero}`);
              }
            }
            
            console.log(`  üìä Total encontrados con m√©todo gen√©rico: ${numerosGenericos.length}`);
            
            // Combinar resultados (priorizar m√©todo 1)
            numerosGenericos.forEach(n => {
              if (!numeros.includes(n)) numeros.push(n);
            });
          }
          
          // Ordenar n√∫meros y tomar los primeros 36
          numeros.sort((a, b) => a - b);
          const resultadosFinales = numeros.slice(0, 36);
          
          console.log("\nüìä RESULTADO FINAL:");
          console.log(`  Total n√∫meros √∫nicos encontrados: ${numeros.length}`);
          console.log(`  Primeros 36: ${resultadosFinales.join(', ')}`);
          
          // Guardar en JSON
          const datos = {
            resultados: resultadosFinales,
            fecha_actualizacion: new Date().toISOString(),
            total_resultados: resultadosFinales.length,
            debug: {
              total_bruto: numeros.length,
              metodos: {
                h4: numeros.length
              }
            }
          };
          
          fs.writeFileSync('resultados.json', JSON.stringify(datos, null, 2));
          console.log('\n‚úÖ Archivo resultados.json guardado correctamente');
          EOF
          
      - name: Ejecutar script de extracci√≥n
        run: node extraer.js
        
      - name: Verificar resultado
        run: |
          echo "üìÅ Contenido de resultados.json:"
          cat resultados.json
          
      - name: Configurar Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
      - name: Guardar cambios en el repositorio
        run: |
          # Traer √∫ltimos cambios remotos
          git fetch origin main
          
          # Reset suave para mantener cambios locales
          git reset --soft origin/main
          
          # Agregar archivos y hacer commit si hay cambios
          git add resultados.json
          
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è No hay cambios para commitear"
          else
            git commit -m "üîÑ Actualizaci√≥n autom√°tica de resultados [$(date +'%Y-%m-%d %H:%M')]"
            git push origin HEAD:main
            echo "‚úÖ Cambios subidos a GitHub"
          fi
