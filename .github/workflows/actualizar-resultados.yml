name: Actualizar Resultados Lotto Activo

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  actualizar:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Clonar repositorio
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: Obtener p√°gina de resultados
        run: |
          echo "üîç Obteniendo resultados de loteriadehoy.com..."
          curl -s -L -v "https://loteriadehoy.com/animalito/lottoactivo/resultados/" > resultados.html
          echo "‚úÖ P√°gina descargada. Tama√±o: $(wc -l < resultados.html) l√≠neas"
          
      - name: Mostrar primeras l√≠neas (depuraci√≥n)
        run: |
          echo "üìÑ Primeras 20 l√≠neas del HTML:"
          head -20 resultados.html
          
      - name: Configurar Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Extraer n√∫meros con M√öLTIPLES M√âTODOS
        run: |
          cat > extraer.js << 'EOF'
          const fs = require('fs');
          
          console.log("üîç Iniciando extracci√≥n m√∫ltiple...");
          const html = fs.readFileSync('resultados.html', 'utf8');
          
          // ===== M√âTODO 1: Buscar en etiquetas H4 =====
          console.log("\nüìå M√âTODO 1: Buscando en <h4>...");
          const regexH4 = /<h4[^>]*>(\d{1,2})\s+([A-Za-z√Å-√∫]+)<\/h4>/gi;
          const numerosH4 = [];
          let match;
          
          while ((match = regexH4.exec(html)) !== null) {
            const numero = parseInt(match[1]);
            if (numero >= 0 && numero <= 36) {
              numerosH4.push(numero);
              console.log(`  ‚úì H4: ${numero} - ${match[2]}`);
            }
          }
          console.log(`  Total H4: ${numerosH4.length}`);
          
          // ===== M√âTODO 2: Buscar n√∫meros en cualquier etiqueta =====
          console.log("\nüìå M√âTODO 2: Buscando n√∫meros en etiquetas...");
          const regexEtiquetas = /<[^>]+>(\d{1,2})<\/[^>]+>/g;
          const numerosEtiquetas = [];
          let match2;
          
          while ((match2 = regexEtiquetas.exec(html)) !== null) {
            const numero = parseInt(match2[1]);
            if (numero >= 0 && numero <= 36 && !numerosEtiquetas.includes(numero)) {
              numerosEtiquetas.push(numero);
              console.log(`  ‚úì Etiqueta: ${numero}`);
            }
          }
          console.log(`  Total en etiquetas: ${numerosEtiquetas.length}`);
          
          // ===== M√âTODO 3: B√∫squeda gen√©rica por patr√≥n n√∫mero + animal =====
          console.log("\nüìå M√âTODO 3: B√∫squeda gen√©rica n√∫mero+animal...");
          const regexGeneral = /(\d{1,2})\s+([A-Za-z√Å-√∫]+)/g;
          const numerosGenerales = [];
          let match3;
          
          while ((match3 = regexGeneral.exec(html)) !== null) {
            const numero = parseInt(match3[1]);
            if (numero >= 0 && numero <= 36 && !numerosGenerales.includes(numero)) {
              numerosGenerales.push(numero);
              console.log(`  ‚úì General: ${numero} - ${match3[2]}`);
            }
          }
          console.log(`  Total general: ${numerosGenerales.length}`);
          
          // ===== SELECCIONAR EL MEJOR RESULTADO =====
          let numerosFinales = [];
          if (numerosH4.length >= 8) {
            console.log("\n‚úÖ Usando M√âTODO 1 (H4)");
            numerosFinales = numerosH4;
          } else if (numerosEtiquetas.length >= 8) {
            console.log("\n‚úÖ Usando M√âTODO 2 (Etiquetas)");
            numerosFinales = numerosEtiquetas;
          } else if (numerosGenerales.length >= 8) {
            console.log("\n‚úÖ Usando M√âTODO 3 (General)");
            numerosFinales = numerosGenerales;
          } else {
            console.log("\n‚ö†Ô∏è NING√öN M√âTODO encontr√≥ suficientes n√∫meros");
            numerosFinales = numerosGenerales.length > 0 ? numerosGenerales : 
                            (numerosEtiquetas.length > 0 ? numerosEtiquetas : numerosH4);
          }
          
          // Eliminar duplicados y ordenar
          numerosFinales = [...new Set(numerosFinales)].sort((a, b) => a - b);
          
          console.log(`\nüìä RESULTADO FINAL: ${numerosFinales.length} n√∫meros`);
          console.log(`   N√∫meros: ${numerosFinales.join(', ')}`);
          
          // Guardar resultados
          const datos = {
            resultados: numerosFinales,
            fecha_actualizacion: new Date().toISOString(),
            total_resultados: numerosFinales.length,
            debug: {
              metodo1: numerosH4.length,
              metodo2: numerosEtiquetas.length,
              metodo3: numerosGenerales.length
            }
          };
          
          fs.writeFileSync('resultados.json', JSON.stringify(datos, null, 2));
          console.log('\n‚úÖ resultados.json actualizado');
          EOF
          
      - name: Ejecutar script
        run: node extraer.js
        
      - name: Mostrar resultado
        run: cat resultados.json
        
      - name: Guardar cambios
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git reset --soft origin/main
          git add resultados.json
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è Sin cambios"
          else
            git commit -m "üîÑ Actualizaci√≥n autom√°tica $(date +'%Y-%m-%d %H:%M')"
            git push origin HEAD:main
            echo "‚úÖ Cambios subidos"
          fi
