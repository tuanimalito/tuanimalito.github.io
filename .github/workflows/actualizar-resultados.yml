name: Actualizar Resultados Lotto Activo

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  actualizar:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Clonar repositorio
        uses: actions/checkout@v3
        
      - name: Obtener p√°gina de resultados
        run: |
          echo "üîç Obteniendo resultados de Lotto Activo..."
          curl -s -L "https://resultados365.com/resultados/Lotto+Activo+" > resultados.html
          
      - name: MOSTRAR las primeras l√≠neas del HTML (DEPURACI√ìN)
        run: |
          echo "üìÑ Primeras 20 l√≠neas del HTML:"
          head -20 resultados.html
          echo ""
          echo "üîç Buscando patrones de n√∫meros y animales..."
          grep -E '<[^>]*>[0-9]{1,2}<[^>]*>' resultados.html | head -10
          
      - name: Extraer n√∫meros con Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Crear script de extracci√≥n mejorado
        run: |
          cat > extraer.js << 'EOF'
          const fs = require('fs');
          
          // Leer el HTML
          const html = fs.readFileSync('resultados.html', 'utf8');
          
          console.log("üîç Analizando HTML...");
          
          // M√âTODO 1: Buscar n√∫meros en etiquetas
          const numeros = [];
          const regex1 = />(\d{1,2})</g;
          let match1;
          while ((match1 = regex1.exec(html)) !== null) {
            const numero = parseInt(match1[1]);
            if (numero >= 0 && numero <= 36 && !numeros.includes(numero)) {
              numeros.push(numero);
            }
          }
          
          console.log(`üìä M√©todo 1 - Encontr√≥ ${numeros.length} n√∫meros √∫nicos:`, numeros);
          
          // M√âTODO 2: Buscar n√∫meros cerca de animales conocidos
          const animalesConocidos = [
            'zamuro','raton','caiman','perro','carnero','ardilla','perico','ballena',
            'pavo','iguana','toro','mono','caballo','gato','tigre','aguila','leon',
            'rana','alacran','ciempies','zorro','oso','burro','chivo','cochino',
            'gallo','camello','cebra','gallina','vaca','elefante','lapa','pescado',
            'venado','jirafa','culebra'
          ];
          
          const numeros2 = [];
          const regex2 = />(\d{1,2})<[^>]*>([A-Za-z√Å-√∫]+)</gi;
          let match2;
          while ((match2 = regex2.exec(html)) !== null) {
            const numero = parseInt(match2[1]);
            const animal = match2[2].toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            
            if (numero >= 0 && numero <= 36 && animalesConocidos.includes(animal)) {
              numeros2.push(numero);
            }
          }
          
          console.log(`üìä M√©todo 2 - Encontr√≥ ${numeros2.length} n√∫meros con animales:`, numeros2);
          
          // Usar el m√©todo que m√°s n√∫meros encontr√≥
          const numerosFinales = numeros2.length >= numeros.length ? numeros2 : numeros;
          
          // Guardar resultados
          const datos = {
            resultados: numerosFinales.slice(0, 36),
            fecha_actualizacion: new Date().toISOString(),
            total_resultados: Math.min(numerosFinales.length, 36),
            metodos: {
              metodo1: numeros.length,
              metodo2: numeros2.length
            }
          };
          
          fs.writeFileSync('resultados.json', JSON.stringify(datos, null, 2));
          console.log('‚úÖ RESULTADO FINAL:', datos);
          EOF
          
      - name: Ejecutar script
        run: node extraer.js
        
      - name: Mostrar resultados finales
        run: cat resultados.json
        
      - name: Guardar cambios
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add resultados.html resultados.json
          git diff --quiet && git diff --staged --quiet || git commit -m "üîÑ Actualizaci√≥n autom√°tica [$(date +'%Y-%m-%d %H:%M')]"
          git push
