name: Actualizar Resultados Lotto Activo (3 D√≠as Anteriores)

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  actualizar:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Clonar repositorio
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: Obtener resultados de los 3 d√≠as anteriores
        run: |
          echo "üîç Obteniendo resultados de loteriadehoy.com..."
          
          # Calcular fechas de los 3 d√≠as anteriores
          DIA1=$(date -d "3 days ago" +'%Y-%m-%d')  # 13/02/2026
          DIA2=$(date -d "2 days ago" +'%Y-%m-%d')  # 14/02/2026
          DIA3=$(date -d "1 day ago" +'%Y-%m-%d')   # 15/02/2026
          
          echo "üìÖ Buscando resultados de:"
          echo "   D√≠a -3: $DIA1"
          echo "   D√≠a -2: $DIA2"
          echo "   D√≠a -1: $DIA3"
          
          # Descargar cada d√≠a
          curl -s -L "https://loteriadehoy.com/animalito/lottoactivo/resultados/${DIA1}/" > dia1.html
          curl -s -L "https://loteriadehoy.com/animalito/lottoactivo/resultados/${DIA2}/" > dia2.html
          curl -s -L "https://loteriadehoy.com/animalito/lottoactivo/resultados/${DIA3}/" > dia3.html
          
          echo "‚úÖ HTMLs descargados"
          
      - name: Extraer n√∫meros reales
        run: |
          # Funci√≥n para extraer n√∫meros de un HTML
          extraer_numeros() {
            grep -o '<h4>[0-9]\+' "$1" | sed 's/<h4>//' | head -12 | tr '\n' ',' | sed 's/,$//'
          }
          
          # Extraer n√∫meros de cada d√≠a
          NUM1=$(extraer_numeros dia1.html)
          NUM2=$(extraer_numeros dia2.html)
          NUM3=$(extraer_numeros dia3.html)
          
          # Verificar que tenemos n√∫meros reales
          if [ -z "$NUM1" ] || [ -z "$NUM2" ] || [ -z "$NUM3" ]; then
            echo "‚ùå No se pudieron obtener n√∫meros reales"
            exit 1
          fi
          
          echo "üìä N√∫meros encontrados:"
          echo "   D√≠a -3: $NUM1"
          echo "   D√≠a -2: $NUM2"
          echo "   D√≠a -1: $NUM3"
          
          # Crear JSON con los n√∫meros reales
          cat > resultados.json << EOF
          {
            "resultados": [$NUM1,$NUM2,$NUM3],
            "fecha_actualizacion": "$(date -Iseconds)",
            "total_resultados": 36,
            "dias": {
              "dia_menos_3": "$DIA1",
              "dia_menos_2": "$DIA2",
              "dia_menos_1": "$DIA3"
            },
            "fuente": "loteriadehoy.com (extracci√≥n real)"
          }
          EOF
          
          echo "‚úÖ resultados.json creado con n√∫meros REALES"
          cat resultados.json
          
      - name: Guardar cambios
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git reset --soft origin/main
          git add resultados.json
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è Sin cambios"
          else
            git commit -m "üîÑ Resultados reales d√≠as -3,-2,-1 [$(date +'%Y-%m-%d')]"
            git push origin HEAD:main
            echo "‚úÖ Cambios subidos"
          fi
