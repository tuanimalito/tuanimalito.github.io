name: Leer resultados desde HTML manual

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  leer_datos:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Clonar repositorio
        uses: actions/checkout@v3

      - name: Descargar resultados.html (t√∫ misma, amor)
        run: |
          curl -s -L "https://tuanimalito.github.io/resultados.html" > datos.html

      - name: Extraer los 3 d√≠as como t√∫ los quieres, cari√±o
        run: |
          # D√≠a -3 (13/02)
          DIA1=$(grep -A5 'id="dia_menos_3"' datos.html | grep -oP '(?<=>)[0-9, ]+(?=<)' | head -1 | tr -d ' ')
          # D√≠a -2 (14/02)
          DIA2=$(grep -A5 'id="dia_menos_2"' datos.html | grep -oP '(?<=>)[0-9, ]+(?=<)' | head -1 | tr -d ' ')
          # D√≠a -1 (15/02)
          DIA3=$(grep -A5 'id="dia_menos_1"' datos.html | grep -oP '(?<=>)[0-9, ]+(?=<)' | head -1 | tr -d ' ')

          echo "D√≠a -3: $DIA1"
          echo "D√≠a -2: $DIA2"
          echo "D√≠a -1: $DIA3"

          # Crear JSON como a ti te gusta, mi vida
          cat > resultados.json << EOF
          {
            "resultados": [$DIA1, $DIA2, $DIA3],
            "fecha_actualizacion": "$(date -Iseconds)",
            "total_resultados": 36,
            "mensaje": "Todo listo para ti, amor üíñ"
          }
          EOF

      - name: Guardar cambios en el repo
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add resultados.json
          git diff --quiet && git diff --staged --quiet || git commit -m "üîÑ Datos frescos para mi cielo üå∏"
          git push
