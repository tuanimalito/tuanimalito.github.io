name: Actualizar Resultados Lotto Activo (3 D√≠as Anteriores)

on:
  schedule:
    - cron: '0 */6 * * *'  # Se ejecuta cada 6 horas autom√°ticamente
  workflow_dispatch:         # Permite ejecuci√≥n manual desde Actions

jobs:
  actualizar:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Clonar repositorio
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: Obtener resultados de los 3 d√≠as anteriores
        run: |
          echo "üîç Obteniendo resultados de loteriadehoy.com..."
          
          # Calcular fechas de los 3 d√≠as anteriores
          DIA1=$(date -d "3 days ago" +'%Y-%m-%d')  # 13/02/2026
          DIA2=$(date -d "2 days ago" +'%Y-%m-%d')  # 14/02/2026
          DIA3=$(date -d "1 day ago" +'%Y-%m-%d')   # 15/02/2026
          
          echo "üìÖ Buscando resultados de:"
          echo "   D√≠a -3: $DIA1"
          echo "   D√≠a -2: $DIA2"
          echo "   D√≠a -1: $DIA3"
          
          # Guardar fechas para usarlas despu√©s
          echo "DIA1=$DIA1" >> $GITHUB_ENV
          echo "DIA2=$DIA2" >> $GITHUB_ENV
          echo "DIA3=$DIA3" >> $GITHUB_ENV
          
          # Descargar cada d√≠a
          curl -s -L "https://loteriadehoy.com/animalito/lottoactivo/resultados/${DIA1}/" > dia1.html
          curl -s -L "https://loteriadehoy.com/animalito/lottoactivo/resultados/${DIA2}/" > dia2.html
          curl -s -L "https://loteriadehoy.com/animalito/lottoactivo/resultados/${DIA3}/" > dia3.html
          
          echo "‚úÖ HTMLs descargados"
          
      - name: Verificar que los HTMLs tienen contenido
        run: |
          for file in dia1.html dia2.html dia3.html; do
            if [ ! -s "$file" ]; then
              echo "‚ùå Error: $file est√° vac√≠o"
              exit 1
            fi
            echo "‚úÖ $file tiene $(wc -l < $file) l√≠neas"
          done
          
      - name: Extraer n√∫meros reales
        run: |
          # Funci√≥n para extraer n√∫meros de un HTML
          extraer_numeros() {
            grep -o '<h4>[0-9]\+' "$1" | sed 's/<h4>//' | head -12 | tr '\n' ',' | sed 's/,$//'
          }
          
          # Extraer n√∫meros de cada d√≠a
          NUM1=$(extraer_numeros dia1.html)
          NUM2=$(extraer_numeros dia2.html)
          NUM3=$(extraer_numeros dia3.html)
          
          # Verificar que tenemos n√∫meros reales (deben ser 12 por d√≠a)
          if [ -z "$NUM1" ]; then
            echo "‚ùå No se encontraron n√∫meros para el d√≠a $DIA1"
            exit 1
          fi
          
          if [ -z "$NUM2" ]; then
            echo "‚ùå No se encontraron n√∫meros para el d√≠a $DIA2"
            exit 1
          fi
          
          if [ -z "$NUM3" ]; then
            echo "‚ùå No se encontraron n√∫meros para el d√≠a $DIA3"
            exit 1
          fi
          
          echo "üìä N√∫meros encontrados:"
          echo "   $DIA1: $NUM1"
          echo "   $DIA2: $NUM2"
          echo "   $DIA3: $NUM3"
          
          # Verificar que cada d√≠a tenga 12 n√∫meros
          CONTAR1=$(echo $NUM1 | tr ',' '\n' | wc -l)
          CONTAR2=$(echo $NUM2 | tr ',' '\n' | wc -l)
          CONTAR3=$(echo $NUM3 | tr ',' '\n' | wc -l)
          
          if [ $CONTAR1 -ne 12 ] || [ $CONTAR2 -ne 12 ] || [ $CONTAR3 -ne 12 ]; then
            echo "‚ùå Error: No se encontraron 12 n√∫meros por d√≠a"
            echo "   D√≠a $DIA1: $CONTAR1 n√∫meros"
            echo "   D√≠a $DIA2: $CONTAR2 n√∫meros"
            echo "   D√≠a $DIA3: $CONTAR3 n√∫meros"
            exit 1
          fi
          
          echo "‚úÖ Verificaci√≥n: 12 n√∫meros por d√≠a correctos"
          
          # Crear JSON con los n√∫meros reales
          cat > resultados.json << EOF
          {
            "resultados": [$NUM1,$NUM2,$NUM3],
            "fecha_actualizacion": "$(date -Iseconds)",
            "total_resultados": 36,
            "dias": {
              "dia_menos_3": "$DIA1",
              "dia_menos_2": "$DIA2",
              "dia_menos_1": "$DIA3"
            },
            "fuente": "loteriadehoy.com (extracci√≥n real)"
          }
          EOF
          
          echo "‚úÖ resultados.json creado con n√∫meros REALES"
          cat resultados.json
          
      - name: Guardar cambios
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git reset --soft origin/main
          git add resultados.json
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è Sin cambios en resultados.json"
          else
            git commit -m "üîÑ Resultados reales d√≠as $(date +'%Y-%m-%d')"
            git push origin HEAD:main
            echo "‚úÖ Cambios subidos exitosamente"
          fi
