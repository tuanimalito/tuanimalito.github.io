name: Actualizar resultados rotando los 3 d√≠as

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  rotar_resultados:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Clonar repositorio
        uses: actions/checkout@v3

      - name: Obtener resultados de hoy desde El Brujo
        run: |
          curl -s -L "https://elbrujodelosanimalitos.com/resultados-animalitos/" > hoy.html

      - name: Extraer n√∫meros de Lotto Activo (hoy)
        run: |
          # Buscar la secci√≥n "## Lotto Activo" y extraer las l√≠neas con n√∫meros
          numeros_hoy=$(grep -A20 '## Lotto Activo' hoy.html | grep -oP '(?<=>)\d+(?= -)' | head -12 | tr '\n' ',' | sed 's/,$//')
          echo "NUMEROS_HOY=$numeros_hoy" >> $GITHUB_ENV

      - name: Leer resultados.json anterior y rotar
        run: |
          # Si existe resultados.json, lo leemos
          if [ -f resultados.json ]; then
            # Extraer los arrays (esto es un poco artesanal pero efectivo)
            OLD_JSON=$(cat resultados.json)
            DIA1=$(echo "$OLD_JSON" | grep -oP '(?<="resultados": \[)[^\]]+' | head -1 | tr -d ' ' | sed 's/,/ /g')
            DIA2=$(echo "$OLD_JSON" | grep -oP '(?<="resultados": \[)[^\]]+' | tail -2 | head -1 | tr -d ' ' | sed 's/,/ /g')
            DIA3=$(echo "$OLD_JSON" | grep -oP '(?<="resultados": \[)[^\]]+' | tail -1 | tr -d ' ' | sed 's/,/ /g')
            
            # Rotar: el d√≠a -3 se elimina, los dem√°s se desplazan
            NUEVO_DIA1=$DIA2
            NUEVO_DIA2=$DIA3
            NUEVO_DIA3=${{ env.NUMEROS_HOY }}
          else
            # Si no existe, usamos los datos que ya ten√≠as como base
            NUEVO_DIA1="35,21,16,30,0,5,28,2,29,7,36,32"   # 14/02 (pasa a ser d√≠a -3)
            NUEVO_DIA2="28,8,30,27,1,32,7,0,17,24,2,19"     # 15/02 (pasa a ser d√≠a -2)
            NUEVO_DIA3="${{ env.NUMEROS_HOY }}"             # 16/02 (d√≠a -1)
          fi

          # Guardar en nuevo JSON
          cat > resultados.json << EOF
          {
            "resultados": [$NUEVO_DIA1, $NUEVO_DIA2, $NUEVO_DIA3],
            "fecha_actualizacion": "$(date -Iseconds)",
            "total_resultados": 36,
            "dias": {
              "dia_menos_3": "$(date -d '3 days ago' +'%Y-%m-%d')",
              "dia_menos_2": "$(date -d '2 days ago' +'%Y-%m-%d')",
              "dia_menos_1": "$(date -d '1 day ago' +'%Y-%m-%d')"
            }
          }
          EOF

      - name: Guardar cambios
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add resultados.json
          git diff --quiet && git diff --staged --quiet || git commit -m "üîÑ Resultados rotados autom√°ticamente"
          git push
